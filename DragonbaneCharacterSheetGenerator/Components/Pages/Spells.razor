@page "/spells"
@using System.Text.Json
@using System.Text.Json.Serialization
@using Microsoft.Maui.Storage
@using System.IO
@using System.Text.RegularExpressions
@using System.Linq
@using DragonbaneCharacterSheetGenerator.Shared

@inherits DragonbaneCharacterSheetGenerator.Components.Pages.SpellsBase

<ErrorBoundary Context="err">
    <ChildContent>
        <h1>Spells</h1>

        <p>Browse tricks and spells. Use the filters to narrow by type and school.</p>

        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">Type</label>
                <select class="form-select" @bind="selectedType">
                    <option value="Tricks">Tricks</option>
                    <option value="Spells">Spells</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">School</label>
                <select class="form-select" @bind="selectedSchool">
                    <option value="All">All</option>
                    <option value="Animism">Animism</option>
                    <option value="Elementalism">Elementalism</option>
                    <option value="Mentalism">Mentalism</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Max Rank</label>
                <select class="form-select" @bind="selectedMaxRank">
                    <option value="Any">Any</option>
                    @for (int i = 1; i <= 10; i++)
                    {
                        <option value="@i">@i</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Search</label>
                <input class="form-control" placeholder="Search by name or effect..." @bind="searchTerm" />
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="favOnly" @bind="showFavoritesOnly" />
                        <label class="form-check-label small text-muted" for="favOnly">Favorites only (@(selectedType == "Tricks" ? CountFavoritesForKind("trick") : CountFavoritesForKind("spell")))</label>
                    </div>
                </div>
            </div>
        </div>

        @if (doc == null)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            @if (selectedType == "Tricks")
            {
                <div class="row mt-3">
                    @foreach (var card in FilteredCards)
                    {
                        var isFav = IsFavoriteItem(card.IsSpell, card.Title);
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 @(isFav ? "border-warning" : "")">
                                <div class="card-body" style="cursor:pointer;" @onclick="() => OpenModal(card, false)">
                                    <h5 class="card-title d-flex align-items-center">
                                        <span class="flex-grow-1">@card.Title</span>
                                        <button class="fav-btn @(isFav ? "favorited" : "") ms-2" title="Toggle favorite" @onclick="() => ToggleFavoriteItem(card.IsSpell, card.Title)" @onclick:preventDefault="true" @onclick:stopPropagation="true" aria-label="Toggle favorite">
                                            <i class="@(isFav ? "fa-solid fa-star" : "fa-regular fa-star")" aria-hidden="true"></i>
                                        </button>
                                    </h5>
                                    <h6 class="card-subtitle mb-2 text-muted">@card.Subtitle</h6>
                                    <p class="card-text">@card.Body</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                @* Spells view: if All selected, group by General / Animism / Elementalism / Mentalism *@
                @if (selectedSchool == "All")
                {
                    <h3>General Spells</h3>
                    <div class="row">
                        @foreach (var s in (doc.Spells?.GeneralSpells ?? new List<Spell>()).Where(s => MatchesSearch(s.Name, s.Effect)))
                        {
                            var card = new CardView { Title = s.Name, Subtitle = $"Rank: {s.Rank}", Body = s.Effect, IsSpell = true, Spell = s };
                            if (showFavoritesOnly && !IsFavorite("spell", card.Title)) continue;
                            var isFav = IsFavoriteItem(card.IsSpell, card.Title);
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 @(isFav ? "border-warning" : "")">
                                    <div class="card-body" style="cursor:pointer;" @onclick="() => OpenModal(card, true)">
                                        <h5 class="card-title d-flex align-items-center">
                                            <span class="flex-grow-1">@card.Title</span>
                                            <button class="fav-btn @(isFav ? "favorited" : "") ms-2" title="Toggle favorite" @onclick="() => ToggleFavoriteItem(card.IsSpell, card.Title)" @onclick:preventDefault="true" @onclick:stopPropagation="true" aria-label="Toggle favorite">
                                                <i class="@(isFav ? "fa-solid fa-star" : "fa-regular fa-star")" aria-hidden="true"></i>
                                            </button>
                                        </h5>
                                        <h6 class="card-subtitle mb-2 text-muted">@card.Subtitle</h6>
                                        <p class="card-text">@card.Body</p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <h3 class="mt-4">Animism</h3>
                    <div class="row">
                        @foreach (var s in (doc.Spells?.AnimismSpells ?? new List<Spell>()).Where(s => MatchesSearch(s.Name, s.Effect)))
                        {
                            var card = new CardView { Title = s.Name, Subtitle = $"Rank: {s.Rank} � Animism", Body = s.Effect, IsSpell = true, Spell = s };
                            if (showFavoritesOnly && !IsFavorite("spell", card.Title)) continue;
                            var isFav = IsFavoriteItem(card.IsSpell, card.Title);
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 @(isFav ? "border-warning" : "")">
                                    <div class="card-body" style="cursor:pointer;" @onclick="() => OpenModal(card, true)">
                                        <h5 class="card-title d-flex align-items-center">
                                            <span class="flex-grow-1">@card.Title</span>
                                            <button class="fav-btn @(isFav ? "favorited" : "") ms-2" title="Toggle favorite" @onclick="() => ToggleFavoriteItem(card.IsSpell, card.Title)" @onclick:preventDefault="true" @onclick:stopPropagation="true" aria-label="Toggle favorite">
                                                <i class="@(isFav ? "fa-solid fa-star" : "fa-regular fa-star")" aria-hidden="true"></i>
                                            </button>
                                        </h5>
                                        <h6 class="card-subtitle mb-2 text-muted">@card.Subtitle</h6>
                                        <p class="card-text">@card.Body</p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <h3 class="mt-4">Elementalism</h3>
                    <div class="row">
                        @foreach (var s in (doc.Spells?.ElementalismSpells ?? new List<Spell>()).Where(s => MatchesSearch(s.Name, s.Effect)))
                        {
                            var card = new CardView { Title = s.Name, Subtitle = $"Rank: {s.Rank} � Elementalism", Body = s.Effect, IsSpell = true, Spell = s };
                            if (showFavoritesOnly && !IsFavorite("spell", card.Title)) continue;
                            var isFav = IsFavoriteItem(card.IsSpell, card.Title);
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 @(isFav ? "border-warning" : "")">
                                    <div class="card-body" style="cursor:pointer;" @onclick="() => OpenModal(card, true)">
                                        <h5 class="card-title d-flex align-items-center">
                                            <span class="flex-grow-1">@card.Title</span>
                                            <button class="fav-btn @(isFav ? "favorited" : "") ms-2" title="Toggle favorite" @onclick="() => ToggleFavoriteItem(card.IsSpell, card.Title)" @onclick:preventDefault="true" @onclick:stopPropagation="true" aria-label="Toggle favorite">
                                                <i class="@(isFav ? "fa-solid fa-star" : "fa-regular fa-star")" aria-hidden="true"></i>
                                            </button>
                                        </h5>
                                        <h6 class="card-subtitle mb-2 text-muted">@card.Subtitle</h6>
                                        <p class="card-text">@card.Body</p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <h3 class="mt-4">Mentalism</h3>
                    <div class="row">
                        @foreach (var s in (doc.Spells?.MentalismSpells ?? new List<Spell>()).Where(s => MatchesSearch(s.Name, s.Effect)))
                        {
                            var card = new CardView { Title = s.Name, Subtitle = $"Rank: {s.Rank} � Mentalism", Body = s.Effect, IsSpell = true, Spell = s };
                            if (showFavoritesOnly && !IsFavorite("spell", card.Title)) continue;
                            var isFav = IsFavoriteItem(card.IsSpell, card.Title);
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 @(isFav ? "border-warning" : "")">
                                    <div class="card-body" style="cursor:pointer;" @onclick="() => OpenModal(card, true)">
                                        <h5 class="card-title d-flex align-items-center">
                                            <span class="flex-grow-1">@card.Title</span>
                                            <button class="fav-btn @(isFav ? "favorited" : "") ms-2" title="Toggle favorite" @onclick="() => ToggleFavoriteItem(card.IsSpell, card.Title)" @onclick:preventDefault="true" @onclick:stopPropagation="true" aria-label="Toggle favorite">
                                                <i class="@(isFav ? "fa-solid fa-star" : "fa-regular fa-star")" aria-hidden="true"></i>
                                            </button>
                                        </h5>
                                        <h6 class="card-subtitle mb-2 text-muted">@card.Subtitle</h6>
                                        <p class="card-text">@card.Body</p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="row mt-3">
                        @foreach (var card in FilteredCards)
                        {
                            var isFav = IsFavoriteItem(card.IsSpell, card.Title);
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 @(isFav ? "border-warning" : "")">
                                    <div class="card-body" style="cursor:pointer;" @onclick="() => OpenModal(card, true)">
                                        <h5 class="card-title d-flex align-items-center">
                                            <span class="flex-grow-1">@card.Title</span>
                                            @if (card.IsSpell)
                                            {
                                                <button class="fav-btn @(isFav ? "favorited" : "") ms-2" title="Toggle favorite" @onclick="() => ToggleFavoriteItem(card.IsSpell, card.Title)" @onclick:preventDefault="true" @onclick:stopPropagation="true" aria-label="Toggle favorite">
                                                    <i class="@(isFav ? "fa-solid fa-star" : "fa-regular fa-star")" aria-hidden="true"></i>
                                                </button>
                                            }
                                        </h5>
                                        <h6 class="card-subtitle mb-2 text-muted">@card.Subtitle</h6>
                                        <p class="card-text">@card.Body</p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }

            @* Modal *@
            @if (showModal && modalCard != null)
            {
                <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title d-flex align-items-center">
                                    <span class="flex-grow-1">@modalCard.Title</span>
                                    <button class="fav-btn @(IsFavoriteItem(modalCard.IsSpell, modalCard.Title) ? "favorited" : "") ms-2" title="Toggle favorite" @onclick="() => ToggleFavoriteItem(modalCard.IsSpell, modalCard.Title)" @onclick:preventDefault="true" @onclick:stopPropagation="true" aria-label="Toggle favorite">
                                        <i class="@(IsFavoriteItem(modalCard.IsSpell, modalCard.Title) ? "fa-solid fa-star" : "fa-regular fa-star")" aria-hidden="true"></i>
                                    </button>
                                </h5>
                                <button type="button" class="btn-close" @onclick="CloseModal"></button>
                            </div>
                            <div class="modal-body">
                                <h6 class="text-muted">@modalCard.Subtitle</h6>

                                @if (modalCard.IsSpell && modalCard.Spell != null)
                                {
                                    <div class="mb-2 small text-muted">
                                        <span class="me-3"><strong>Prereq:</strong>
                                            @if (!string.IsNullOrWhiteSpace(modalCard.Spell.Prerequisite))
                                            {
                                                var tokens = SplitPrerequisites(modalCard.Spell.Prerequisite).ToList();
                                                for (int i = 0; i < tokens.Count; i++)
                                                {
                                                    var t = tokens[i];
                                                    var found = FindSpellByName(t);
                                                    if (found != null)
                                                    {
                                                        <a href="#" @onclick="() => OpenPrereqBySpell(found)" @onclick:preventDefault="true" @onclick:stopPropagation="true">@t</a>
                                                    }
                                                    else
                                                    {
                                                        @t
                                                    }
                                                    if (i < tokens.Count - 1)
                                                    {
                                                        <text>, </text>
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                <text>-</text>
                                            }
                                        </span>
                                        <span class="me-3"><strong>Cast:</strong> @(!string.IsNullOrWhiteSpace(modalCard.Spell.CastTime) ? modalCard.Spell.CastTime : "-")</span>
                                        <span class="me-3"><strong>Range:</strong> @(!string.IsNullOrWhiteSpace(modalCard.Spell.Range) ? modalCard.Spell.Range : "-")</span>
                                        <span class="me-3"><strong>Duration:</strong> @(!string.IsNullOrWhiteSpace(modalCard.Spell.Duration) ? modalCard.Spell.Duration : "-")</span>
                                    </div>
                                }

                                <p>@modalCard.Body</p>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" @onclick="CloseModal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </ChildContent>

    <ErrorContent>
        <div class="alert alert-danger">
            <h4>Unhandled error while rendering Spells</h4>
            <pre>@err.ToString()</pre>
        </div>
    </ErrorContent>
</ErrorBoundary>


