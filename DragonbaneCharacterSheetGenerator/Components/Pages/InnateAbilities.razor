@page "/innate-abilities"
@using System.Text.Json
@using System.Text.Json.Serialization
@using Microsoft.Maui.Storage

<ErrorBoundary Context="err">
 <ChildContent>
 <h1>Innate Abilities</h1>

 <p>This page shows the list of innate abilities (grouped by kin) from a local JSON file.</p>

 <input class="form-control" placeholder="Search abilities by kin, name or description..." @bind="searchTerm" />

 @if (abilities == null)
 {
 <p><em>Loading...</em></p>
 }
 else
 {
 <div class="row mt-3">
 @foreach (var ability in FilteredAbilities)
 {
 <div class="col-md-6 mb-3">
 <div class="card h-100">
 <div class="card-body">
 <h5 class="card-title">@ability.Name <small class="text-muted">(WP: @ability.WPDisplay)</small></h5>
 <h6 class="card-subtitle mb-2 text-muted">Kin: @ability.Kin</h6>
 <p class="card-text">@ability.Description</p>
 </div>
 </div>
 </div>
 }
 </div>
 }
 </ChildContent>

 <ErrorContent>
 <div class="alert alert-danger">
 <h4>Unhandled error while rendering Innate Abilities</h4>
 <pre>@err.ToString()</pre>
 </div>
 </ErrorContent>
</ErrorBoundary>

@code {
 private List<InnateAbility>? abilities;
 private string searchTerm = string.Empty;

 private IEnumerable<InnateAbility> FilteredAbilities =>
 string.IsNullOrWhiteSpace(searchTerm)
 ? abilities ?? Enumerable.Empty<InnateAbility>()
 : (abilities ?? Enumerable.Empty<InnateAbility>()).Where(a =>
 (a.Kin ?? string.Empty).Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
 (a.Name ?? string.Empty).Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
 (a.Description ?? string.Empty).Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
 );

 protected override async Task OnInitializedAsync()
 {
 try
 {
 await using var stream = await FileSystem.OpenAppPackageFileAsync("wwwroot/doc/innateAbilities.json");
 var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
 var kinList = await JsonSerializer.DeserializeAsync<List<KinEntry>>(stream, options);

 abilities = kinList?.SelectMany(k => (k.Abilities ?? new List<InnateAbilitySource>()).Select(a => new InnateAbility
 {
 Kin = k.Kin,
 Name = a.Name,
 Wp = a.Wp,
 Description = a.Description
 })).ToList() ?? new List<InnateAbility>();
 }
 catch (Exception ex)
 {
 abilities = new List<InnateAbility>();
 // show error in one of the cards area by adding a dummy ability
 abilities.Add(new InnateAbility { Kin = "Error", Name = "Failed to load", Description = ex.Message, Wp = new JsonElement() });
 }
 }

 private class KinEntry
 {
 [JsonPropertyName("kin")]
 public string? Kin { get; set; }
 [JsonPropertyName("abilities")]
 public List<InnateAbilitySource>? Abilities { get; set; }
 }

 private class InnateAbilitySource
 {
 [JsonPropertyName("name")]
 public string? Name { get; set; }
 [JsonPropertyName("wp")]
 public JsonElement Wp { get; set; }
 [JsonPropertyName("description")]
 public string? Description { get; set; }
 }

 private class InnateAbility
 {
 public string? Kin { get; set; }
 public string? Name { get; set; }
 public JsonElement Wp { get; set; }
 public string? Description { get; set; }

 public string WPDisplay
 {
 get
 {
 try
 {
 if (Wp.ValueKind == JsonValueKind.Undefined || Wp.ValueKind == JsonValueKind.Null)
 return "-";
 if (Wp.ValueKind == JsonValueKind.Number && Wp.TryGetInt32(out var n))
 return n.ToString();
 if (Wp.ValueKind == JsonValueKind.String)
 return Wp.GetString() ?? "-";
 }
 catch { }
 return Wp.ToString() ?? "-";
 }
 }
 }
}
